<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ambient 24/7 Clock</title>
  <style>
    :root {
      --bg-h1: 30;
      --bg-h2: 200;
      --bg-s1: 40%;
      --bg-s2: 30%;
      --bg-l1: 6%;
      --bg-l2: 10%;
      --accent: 40, 55%, 52%;
      --text: 0, 0%, 96%;
      --dim-text: 0, 0%, 70%;
      --glass: 0 10px 40px rgba(0,0,0,.22);
      --brightness: 0.1;
      --bg-angle: 160deg;
      --anim-amount: 0.5;
      --parallax-opacity: 0.2;
    }

    html, body { height:100%; margin:0; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: hsl(var(--text));
      background: linear-gradient(
        var(--bg-angle),
        hsl(var(--bg-h1), var(--bg-s1), calc(var(--bg-l1) + var(--brightness) * 40%)) 0%,
        hsl(var(--bg-h2), var(--bg-s2), calc(var(--bg-l2) + var(--brightness) * 52%)) 100%
      );
      background-attachment: fixed;
      transition: background 1s ease;
      overflow: hidden;
    }

    .drift { animation: drift 120s ease-in-out infinite alternate; }
    @keyframes drift {
      from { filter: hue-rotate(0deg) saturate(1); }
      to   { filter: hue-rotate(6deg) saturate(1.02); }
    }

    .wrap {
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      padding:24px;
    }

    .clock {
      position:relative;
      width:min(860px, 92vw);
      border-radius:28px;
      background:rgba(0,0,0,0.22);
      backdrop-filter:blur(12px);
      box-shadow:var(--glass);
      padding:clamp(20px, 4vw, 36px);
      display:grid;
      gap:16px;
      z-index:1;
    }

    .time {
      font-size:clamp(42px, 8vw, 96px);
      font-weight:700;
      letter-spacing:0.02em;
      line-height:1.05;
    }

    .date-row {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:baseline;
    }

    .date {
      opacity:.9;
      font-size:clamp(16px, 2.6vw, 22px);
    }

    .weather {
      opacity:.8;
      font-size:clamp(14px, 2.2vw, 18px);
    }

    .controls {
      display:grid;
      gap:10px;
      grid-template-columns:1fr;
    }

    .row {
      display:grid;
      gap:10px;
      grid-template-columns:1fr 1fr;
    }
    .row > * { min-width:0; }

    label {
      font-size:14px;
      color:hsl(var(--dim-text));
      display:block;
      margin-bottom:6px;
    }

    select,
    input[type="text"],
    input[type="number"],
    button {
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06);
      color:#fff;
      outline:none;
      box-sizing:border-box;
    }

    input[type="range"] { width:100%; }

    .chip {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-size:13px;
    }

    .footer {
      display:flex;
      justify-content:space-between;
      align-items:center;
      opacity:.8;
      font-size:12px;
      gap:8px;
      flex-wrap:wrap;
    }

    .btn { cursor:pointer; }

    .reset-btn {
      width:auto;
      padding:4px 9px;
      margin-left:4px;
      border-radius:999px;
      font-size:10px;
      opacity:.85;
      white-space:nowrap;
    }

    /* Parallax aurora overlay */
    .parallax {
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:0;
      opacity:var(--parallax-opacity);
      mix-blend-mode:overlay;
      filter:blur(0.5px);
    }

    .parallax::before {
      content:"";
      position:absolute;
      inset:-10%;
      background:
        radial-gradient(60% 40% at 30% 30%, rgba(255,255,255,0.05), rgba(255,255,255,0) 60%),
        radial-gradient(40% 30% at 70% 60%, rgba(255,255,255,0.04), rgba(255,255,255,0) 60%),
        conic-gradient(from 0deg at 50% 50%, rgba(255,255,255,0.04), rgba(0,0,0,0) 50%, rgba(255,255,255,0.04));
      transform:translate3d(var(--px,0px), var(--py,0px), 0) rotate(var(--prot,0deg));
    }

    /* Narrower lat/lon layout */
    .coords-grid {
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 120px));
      gap:10px;
      align-items:flex-end;
      justify-content:flex-start;
    }
    .coords-grid .field {
      display:flex;
      flex-direction:column;
    }
    .coords-grid .field label {
      margin-bottom:4px;
      font-size:12px;
    }
    .coords-grid input {
      width:100%;
      padding:8px 10px;
      font-size:12px;
    }
    .coords-grid .btn {
      padding:8px 10px;
      font-size:12px;
    }
  </style>
</head>
<body class="drift">
  <div class="wrap">
    <div class="parallax" aria-hidden="true"></div>

    <div class="clock" role="application" aria-label="Ambient clock">
      <div class="time" id="time">00:00:00</div>
      <div class="date-row">
        <div class="date" id="date">Monday, January 1</div>
        <div class="chip" id="season">Season: ‚Äî</div>
        <div class="weather" id="weather">Weather: (disabled)</div>
      </div>

      <div class="controls">
        <!-- Parallax -->
        <div class="row">
          <div>
            <label>Parallax overlay</label>
            <div class="chip">
              <input id="parallaxEnable" type="checkbox" checked />
              <span>Aurora/halo overlay</span>
            </div>
          </div>
          <div>
            <label for="parallaxAmount">Parallax intensity</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input id="parallaxAmount" type="range" min="0" max="1" step="0.01" value="0.2" data-default="0.2" />
              <button type="button" class="btn reset-btn" data-target="parallaxAmount">Default</button>
            </div>
          </div>
        </div>

        <!-- Gradient animation -->
        <div class="row">
          <div>
            <label>Gradient animation</label>
            <div class="chip">
              <input id="animEnable" type="checkbox" checked />
              <span>Subtle motion</span>
            </div>
          </div>
          <div>
            <label for="animAmount">Animation amount</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input id="animAmount" type="range" min="0" max="1" step="0.01" value="0.5" data-default="0.5" />
              <button type="button" class="btn reset-btn" data-target="animAmount">Default</button>
            </div>
          </div>
        </div>

        <!-- Palette + brightness -->
        <div class="row">
          <div>
            <label for="palette">Monthly palette</label>
            <select id="palette"></select>
          </div>
          <div>
            <label for="brightnessBias">Brightness bias (night‚Üíday)</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input id="brightnessBias" type="range" min="-0.3" max="0.3" step="0.01" value="0" data-default="0" />
              <button type="button" class="btn reset-btn" data-target="brightnessBias">Default</button>
            </div>
          </div>
        </div>

        <!-- Playlists + volume -->
        <div class="row">
          <div>
            <label for="playlist">Playlist</label>
            <select id="playlist"></select>
          </div>
          <div>
            <label for="volume">Volume</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input id="volume" type="range" min="0" max="1" step="0.01" value="0.25" data-default="0.25" />
              <button type="button" class="btn reset-btn" data-target="volume">Default</button>
            </div>
          </div>
        </div>

        <!-- Audio controls -->
        <div class="row">
          <div>
            <label>Audio</label>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="playPause" class="btn">‚ñ∂Ô∏é Play</button>
              <span id="nowPlaying" style="opacity:.8; font-size:13px;">(nothing)</span>
            </div>
            <div style="margin-top:6px; font-size:12px; opacity:.7;">
              Note: browsers require a click before audio can play automatically.
            </div>
          </div>
          <div>
            <label>Hour-on-the-hour switching</label>
            <div class="chip">
              <input id="switchHourly" type="checkbox" checked />
              <span>Change track at top of hour</span>
            </div>
          </div>
        </div>

        <!-- Weather -->
        <div class="row">
          <div>
            <label>Weather sync</label>
            <div class="chip">
              <input id="wxEnable" type="checkbox" />
              <span>Use weather to adjust color</span>
            </div>
          </div>
          <div>
            <div class="coords-grid">
              <div class="field">
                <label for="lat">Lat</label>
                <input id="lat" type="text" placeholder="33.65" />
              </div>
              <div class="field">
                <label for="lon">Lon</label>
                <input id="lon" type="text" placeholder="-117.68" />
              </div>
              <div style="grid-column:1 / -1;">
                <button id="useLocation" class="btn">üìç Use my current location</button>
                <div style="font-size:11px; opacity:.7; margin-top:4px;">
                  Location requires HTTPS or localhost.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Weather desaturation control -->
        <div class="row">
          <div>
            <label for="weatherDesatStrength">Weather desaturation strength</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input id="weatherDesatStrength" type="range" min="0" max="1" step="0.05" value="0.6" data-default="0.6" />
              <button type="button" class="btn reset-btn" data-target="weatherDesatStrength">Default</button>
            </div>
            <div style="font-size:11px; opacity:.65;">
              0 = no change, 1 = very washed-out when overcast.
            </div>
          </div>
          <div></div>
        </div>
      </div>

      <div class="footer">
        <div id="hint">Top of hour track switching is <strong>on</strong>.</div>
        <div>Ambient 24/7 Clock ‚Ä¢ Single file demo</div>
      </div>

      <audio id="audio" preload="auto"></audio>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const elTime = $("time");
    const elDate = $("date");
    const elSeason = $("season");
    const elWeather = $("weather");
    const elPalette = $("palette");
    const elBrightnessBias = $("brightnessBias");
    const elPlaylist = $("playlist");
    const elVolume = $("volume");
    const elPlayPause = $("playPause");
    const elSwitchHourly = $("switchHourly");
    const elWxEnable = $("wxEnable");
    const elLat = $("lat");
    const elLon = $("lon");
    const elAnimEnable = $("animEnable");
    const elAnimAmount = $("animAmount");
    const elParallaxEnable = $("parallaxEnable");
    const elParallaxAmount = $("parallaxAmount");
    const elGeoBtn = $("useLocation");
    const elWeatherDesatStrength = $("weatherDesatStrength");
    const elHint = $("hint");
    const audio = $("audio");
    const parallaxEl = document.querySelector(".parallax");

    // Muted monthly palettes with distinct March/May
    const MONTH_PALETTES = {
      0:  { name: "January ‚Äî Frost & Pine",    h1:210, h2:170, s1:26, s2:20, accent:[160,40,52] },
      1:  { name: "February ‚Äî Plum & Rose",    h1:320, h2:280, s1:30, s2:22, accent:[330,40,52] },
      2:  { name: "March ‚Äî Fresh Moss",        h1:135, h2:210, s1:30, s2:24, accent:[135,36,50] }, // teal/green ‚Üí cool blue
      3:  { name: "April ‚Äî Rainy Azure",       h1:205, h2:220, s1:30, s2:26, accent:[210,40,52] },
      4:  { name: "May ‚Äî Soft Meadow",         h1:95,  h2:15,  s1:28, s2:24, accent:[12,34,55] },  // warm green ‚Üí peach
      5:  { name: "June ‚Äî Coastal Sunrise",    h1:26,  h2:195, s1:32, s2:26, accent:[28,40,52] },
      6:  { name: "July ‚Äî Berry & Midnight",   h1:345, h2:215, s1:30, s2:26, accent:[350,42,52] },
      7:  { name: "August ‚Äî Golden Dusk",      h1:32,  h2:20,  s1:32, s2:26, accent:[32,40,52] },
      8:  { name: "September ‚Äî Harvest Sky",   h1:26,  h2:210, s1:30, s2:26, accent:[28,40,52] },
      9:  { name: "October ‚Äî Spiced Night",    h1:24,  h2:280, s1:32, s2:24, accent:[24,42,52] },
      10: { name: "November ‚Äî Ember & Frost",  h1:22,  h2:200, s1:30, s2:24, accent:[200,34,52] },
      11: { name: "December ‚Äî Evergreen Glow", h1:150, h2:210, s1:26, s2:30, accent:[150,38,52] },
    };

    const store = {
      get k() {
        try { return JSON.parse(localStorage.getItem("ambientClock") || "{}"); }
        catch { return {}; }
      },
      set k(v) { localStorage.setItem("ambientClock", JSON.stringify(v)); },
      patch(p) { this.k = { ...this.k, ...p }; },
    };

    const now = new Date();
    const saved = store.k;

    const state = {
      monthIndex:           saved.monthIndex           ?? now.getMonth(),
      brightnessBias:       saved.brightnessBias       ?? 0,
      switchHourly:         saved.switchHourly         ?? true,
      wxEnable:             saved.wxEnable             ?? false,
      lat:                  saved.lat                  ?? "",
      lon:                  saved.lon                  ?? "",
      volume:               saved.volume               ?? 0.25,
      playlistName:         saved.playlistName         ?? "Example ‚Äî Hourly Loops",
      animEnable:           saved.animEnable           ?? true,
      animAmount:           saved.animAmount           ?? 0.5,
      parallaxEnable:       saved.parallaxEnable       ?? true,
      parallaxAmount:       saved.parallaxAmount       ?? 0.2,
      weatherDesatStrength: saved.weatherDesatStrength ?? 0.6,
      weatherDesat:         saved.weatherDesat         ?? 0,
      lastCloudFrac:        saved.lastCloudFrac        ?? 0,
      timezone:             saved.timezone             ?? null,
    };

    const PLAYLISTS = {
      "Example ‚Äî Hourly Loops": [
        "https://upload.wikimedia.org/wikipedia/commons/transcoded/4/47/Chopin_nocturne_op9_no2.ogg/Chopin_nocturne_op9_no2.ogg.mp3",
        "https://upload.wikimedia.org/wikipedia/commons/transcoded/7/79/Debussy_-_Arabesque_No._1.ogg/Debussy_-_Arabesque_No._1.ogg.mp3",
        "https://upload.wikimedia.org/wikipedia/commons/transcoded/2/2b/Erik_Satie_gymnopedie_1.ogg/Erik_Satie_gymnopedie_1.ogg.mp3",
        "https://upload.wikimedia.org/wikipedia/commons/transcoded/8/80/Mozart_-_Eine_kleine_Nachtmusik_Allegro.ogg/Mozart_-_Eine_kleine_Nachtmusik_Allegro.ogg.mp3",
      ],
      "Ambient ‚Äî Rain & Wind": [
        "https://upload.wikimedia.org/wikipedia/commons/2/21/Rain_on_a_Car_Roof.ogg",
        "https://upload.wikimedia.org/wikipedia/commons/9/96/Wind.ogg",
      ],
    };

    // Build selects
    for (let i = 0; i < 12; i++) {
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = MONTH_PALETTES[i].name;
      if (i === state.monthIndex) opt.selected = true;
      elPalette.appendChild(opt);
    }
    for (const name of Object.keys(PLAYLISTS)) {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      if (name === state.playlistName) opt.selected = true;
      elPlaylist.appendChild(opt);
    }

    // Apply saved UI
    elBrightnessBias.value = state.brightnessBias;
    elSwitchHourly.checked = state.switchHourly;
    elWxEnable.checked = state.wxEnable;
    elLat.value = state.lat;
    elLon.value = state.lon;
    elVolume.value = state.volume;
    audio.volume = state.volume;
    if (elAnimEnable) elAnimEnable.checked = state.animEnable;
    if (elAnimAmount) elAnimAmount.value = state.animAmount;
    if (elParallaxEnable) elParallaxEnable.checked = state.parallaxEnable;
    if (elParallaxAmount) elParallaxAmount.value = state.parallaxAmount;
    elWeatherDesatStrength.value = state.weatherDesatStrength;

    document.documentElement.style.setProperty(
      "--anim-amount",
      state.animEnable ? state.animAmount : 0
    );
    document.documentElement.style.setProperty(
      "--parallax-opacity",
      state.parallaxEnable ? state.parallaxAmount : 0
    );

    const clamp = (x, lo, hi) => Math.min(hi, Math.max(lo, x));
    const lerp  = (a, b, t) => a + (b - a) * t;
    const pad   = (n) => String(n).padStart(2, "0");

    function seasonNameForDate(d) {
      const m = d.getMonth();
      const day = d.getDate();
      if (m < 2 || (m === 2 && day < 20)) return "Winter";
      if (m < 5 || (m === 5 && day < 21)) return "Spring";
      if (m < 8 || (m === 8 && day < 22)) return "Summer";
      if (m < 11 || (m === 11 && day < 21)) return "Autumn";
      return "Winter";
    }

    function getZonedDate() {
      if (!state.timezone) {
        const d = new Date();
        return {
          year: d.getFullYear(),
          month: d.getMonth() + 1,
          day: d.getDate(),
          hours: d.getHours(),
          minutes: d.getMinutes(),
          seconds: d.getSeconds(),
          seasonDate: d,
        };
      }
      try {
        const fmt = new Intl.DateTimeFormat("en-US", {
          timeZone: state.timezone,
          year: "numeric",
          month: "numeric",
          day: "numeric",
          hour: "numeric",
          minute: "numeric",
          second: "numeric",
          hour12: false,
        });
        const parts = fmt.formatToParts(new Date());
        const m = {};
        for (const p of parts) m[p.type] = p.value;
        const year = parseInt(m.year,10);
        const month = parseInt(m.month,10);
        const day = parseInt(m.day,10);
        const hours = parseInt(m.hour,10);
        const minutes = parseInt(m.minute,10);
        const seconds = parseInt(m.second,10);
        const seasonDate = new Date(year, month - 1, day);
        return { year, month, day, hours, minutes, seconds, seasonDate };
      } catch {
        const d = new Date();
        return {
          year: d.getFullYear(),
          month: d.getMonth() + 1,
          day: d.getDate(),
          hours: d.getHours(),
          minutes: d.getMinutes(),
          seconds: d.getSeconds(),
          seasonDate: d,
        };
      }
    }

    function brightnessForTime(hours, minutes) {
      const h = hours + minutes / 60;
      let B;
      if      (h < 5)  B = lerp(0.05, 0.22, h / 5);
      else if (h < 9)  B = lerp(0.22, 0.95, (h - 5) / 4);
      else if (h < 17) B = 0.95;
      else if (h < 22) B = lerp(0.95, 0.32, (h - 17) / 5);
      else             B = lerp(0.32, 0.08, (h - 22) / 2);

      const bias = parseFloat(elBrightnessBias.value || 0);
      return clamp(B + bias, 0.02, 1.0);
    }

    function applyPalette(monthIndex, brightness, seasonDate, desatOverride) {
      const p = MONTH_PALETTES[monthIndex];
      const day = seasonDate.getDate();
      const drift = (day - 15) / 80;

      const baseH1 = p.h1 + drift * 4;
      const baseH2 = p.h2 - drift * 4;

      const desat = typeof desatOverride === "number"
        ? desatOverride
        : (state.weatherDesat || 0);

      const s1 = p.s1 * (1 - desat);
      const s2 = p.s2 * (1 - desat);

      document.documentElement.style.setProperty("--bg-h1", baseH1);
      document.documentElement.style.setProperty("--bg-h2", baseH2);
      document.documentElement.style.setProperty("--bg-s1", s1 + "%");
      document.documentElement.style.setProperty("--bg-s2", s2 + "%");
      document.documentElement.style.setProperty("--bg-l1", "6%");
      document.documentElement.style.setProperty("--bg-l2", "10%");
      document.documentElement.style.setProperty("--brightness", brightness);

      const acc = p.accent;
      const accSat = acc[1] * (1 - desat * 0.5);
      document.documentElement.style.setProperty(
        "--accent",
        `${acc[0]}, ${accSat}%, ${acc[2]}%`
      );

      elSeason.textContent = `Season: ${seasonNameForDate(seasonDate)}`;
    }

    async function refreshWeather() {
      if (!elWxEnable.checked) {
        state.weatherDesat = 0;
        store.patch({ weatherDesat: 0 });
        elWeather.textContent = "Weather: (disabled)";
        const z = getZonedDate();
        const b = brightnessForTime(z.hours, z.minutes);
        applyPalette(state.monthIndex, b, z.seasonDate, 0);
        return;
      }

      const lat = parseFloat(elLat.value);
      const lon = parseFloat(elLon.value);
      if (!isFinite(lat) || !isFinite(lon)) {
        elWeather.textContent = "Weather: set lat/lon";
        return;
      }

      try {
        const url =
          `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
          `&current_weather=true&hourly=cloudcover,precipitation_probability&timezone=auto`;
        const r = await fetch(url);
        const j = await r.json();

        const cw = j.current_weather || {};
        const clouds = (j.hourly?.cloudcover?.[0]) ?? 0;
        const precip = (j.hourly?.precipitation_probability?.[0]) ?? 0;

        let desc = `T ${cw.temperature ?? "‚Äî"}¬∞C, clouds ${clouds}%`;
        if (precip) desc += `, precip ${precip}%`;
        elWeather.textContent = `Weather: ${desc}`;

        if (j.timezone) {
          state.timezone = j.timezone;
          store.patch({ timezone: state.timezone });
        }

        const cloudFrac = clamp(clouds / 100, 0, 1);
        state.lastCloudFrac = cloudFrac;

        const strength = parseFloat(elWeatherDesatStrength.value || state.weatherDesatStrength || 0.6);
        state.weatherDesatStrength = strength;

        const desat = clamp(cloudFrac * strength, 0, 1);
        state.weatherDesat = desat;

        store.patch({
          lastCloudFrac: state.lastCloudFrac,
          weatherDesatStrength: state.weatherDesatStrength,
          weatherDesat: state.weatherDesat,
        });

        const z = getZonedDate();
        const b = brightnessForTime(z.hours, z.minutes);
        applyPalette(state.monthIndex, b, z.seasonDate, desat);
      } catch {
        elWeather.textContent = "Weather: unavailable";
      }
    }

    function useMyLocation() {
      if (!("geolocation" in navigator)) {
        elWeather.textContent = "Weather: Geolocation not supported";
        return;
      }
      const secure =
        location.protocol === "https:" || location.hostname === "localhost";
      if (!secure) {
        elWeather.textContent =
          "Weather: Use HTTPS or localhost for location access";
        return;
      }
      elWeather.textContent = "Weather: requesting location‚Ä¶";
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          elLat.value = latitude.toFixed(5);
          elLon.value = longitude.toFixed(5);
          state.lat = elLat.value;
          state.lon = elLon.value;
          store.patch({ lat: state.lat, lon: state.lon });
          if (!elWxEnable.checked) {
            elWxEnable.checked = true;
            state.wxEnable = true;
            store.patch({ wxEnable: true });
          }
          refreshWeather();
        },
        () => {
          elWeather.textContent =
            "Weather: location permission denied or unavailable";
        },
        { enableHighAccuracy:false, timeout:10000, maximumAge:300000 }
      );
    }

    // Audio
    let currentPlaylist = PLAYLISTS[state.playlistName] || [];

    function setPlaylist(name) {
      state.playlistName = name;
      currentPlaylist = PLAYLISTS[name] || [];
      store.patch({ playlistName: name });
      if (currentPlaylist.length) {
        const { hours } = getZonedDate();
        pickTrackForHour(hours);
      } else {
        audio.pause();
        $("nowPlaying").textContent = "(empty playlist)";
      }
    }

    function pickTrackForHour(hour) {
      if (!currentPlaylist.length) return;
      const idx = hour % currentPlaylist.length;
      const src = currentPlaylist[idx];
      audio.src = src;
      audio.loop = true;
      const name = src.split("/").pop() || "track";
      $("nowPlaying").textContent = `Now playing: ${name}`;
      audio.play().catch(() => {});
    }

    // Tick + animations
    let lastMinute = -1;
    let startTime = performance.now();
    let targetX = 0, targetY = 0, px = 0, py = 0;

    window.addEventListener("mousemove", (e) => {
      const amt = parseFloat(elParallaxAmount?.value || state.parallaxAmount || 0.2);
      const rx = (e.clientX / window.innerWidth) - 0.5;
      const ry = (e.clientY / window.innerHeight) - 0.5;
      targetX = rx * 60 * amt;
      targetY = ry * 60 * amt;
    });

    function tick() {
      const { hours, minutes, seconds, seasonDate } = getZonedDate();

      elTime.textContent = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;

      if (minutes !== lastMinute) {
        lastMinute = minutes;

        elDate.textContent = seasonDate.toLocaleDateString(undefined, {
          weekday: "long",
          month: "long",
          day: "numeric",
          timeZone: state.timezone || undefined,
        });

        const b = brightnessForTime(hours, minutes);
        applyPalette(state.monthIndex, b, seasonDate);

        if (state.wxEnable && minutes % 10 === 0) {
          refreshWeather();
        }
        if (state.switchHourly && minutes === 0) {
          pickTrackForHour(hours);
        }
      }

      if (state.animEnable && state.animAmount > 0) {
        const t = performance.now() - startTime;
        const amount = state.animAmount;
        const offset = Math.sin(t / 8000) * 8 * amount;
        document.documentElement.style.setProperty(
          "--bg-angle",
          `${160 + offset}deg`
        );
      }

      if (state.parallaxEnable && state.parallaxAmount > 0 && parallaxEl) {
        px += (targetX - px) * 0.04;
        py += (targetY - py) * 0.04;
        const wobble =
          Math.sin(performance.now() / 60000) *
          4 *
          state.parallaxAmount;
        parallaxEl.style.setProperty("--px", `${px}px`);
        parallaxEl.style.setProperty("--py", `${py}px`);
        parallaxEl.style.setProperty("--prot", `${wobble}deg`);
      }

      requestAnimationFrame(tick);
    }

    // Reset buttons
    document.querySelectorAll(".reset-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.target;
        const input = document.getElementById(id);
        if (!input) return;
        const defAttr = input.getAttribute("data-default");
        if (defAttr == null) return;
        const def = parseFloat(defAttr);
        input.value = def;

        if (id === "brightnessBias") {
          state.brightnessBias = def;
          store.patch({ brightnessBias: def });
          const z = getZonedDate();
          const b = brightnessForTime(z.hours, z.minutes);
          applyPalette(state.monthIndex, b, z.seasonDate);
        } else if (id === "animAmount") {
          state.animAmount = def;
          if (state.animEnable) {
            document.documentElement.style.setProperty("--anim-amount", def);
          }
          store.patch({ animAmount: def });
        } else if (id === "parallaxAmount") {
          state.parallaxAmount = def;
          if (state.parallaxEnable) {
            document.documentElement.style.setProperty("--parallax-opacity", def);
          }
          store.patch({ parallaxAmount: def });
        } else if (id === "volume") {
          state.volume = def;
          audio.volume = def;
          store.patch({ volume: def });
        } else if (id === "weatherDesatStrength") {
          state.weatherDesatStrength = def;
          elWeatherDesatStrength.value = def;
          const cf = state.lastCloudFrac || 0;
          state.weatherDesat = clamp(cf * state.weatherDesatStrength, 0, 1);
          store.patch({
            weatherDesatStrength: state.weatherDesatStrength,
            weatherDesat: state.weatherDesat,
          });
          const z = getZonedDate();
          const b = brightnessForTime(z.hours, z.minutes);
          applyPalette(state.monthIndex, b, z.seasonDate);
        }
      });
    });

    // Event wiring
    elPalette.addEventListener("change", (e) => {
      state.monthIndex = parseInt(e.target.value, 10);
      store.patch({ monthIndex: state.monthIndex });
      const z = getZonedDate();
      const b = brightnessForTime(z.hours, z.minutes);
      applyPalette(state.monthIndex, b, z.seasonDate);
    });

    elBrightnessBias.addEventListener("input", () => {
      state.brightnessBias = parseFloat(elBrightnessBias.value);
      store.patch({ brightnessBias: state.brightnessBias });
      const z = getZonedDate();
      const b = brightnessForTime(z.hours, z.minutes);
      applyPalette(state.monthIndex, b, z.seasonDate);
    });

    elPlaylist.addEventListener("change", (e) => setPlaylist(e.target.value));

    elVolume.addEventListener("input", () => {
      state.volume = parseFloat(elVolume.value);
      audio.volume = state.volume;
      store.patch({ volume: state.volume });
    });

    elPlayPause.addEventListener("click", () => {
      if (audio.paused) {
        audio.play().catch(() => {});
        elPlayPause.textContent = "‚è∏ Pause";
      } else {
        audio.pause();
        elPlayPause.textContent = "‚ñ∂Ô∏é Play";
      }
    });

    elSwitchHourly.addEventListener("change", () => {
      state.switchHourly = elSwitchHourly.checked;
      store.patch({ switchHourly: state.switchHourly });
      elHint.innerHTML =
        `Top of hour track switching is <strong>${state.switchHourly ? "on" : "off"}</strong>.`;
      if (state.switchHourly) {
        const { hours } = getZonedDate();
        pickTrackForHour(hours);
      }
    });

    elWxEnable.addEventListener("change", () => {
      state.wxEnable = elWxEnable.checked;
      store.patch({ wxEnable: state.wxEnable });
      refreshWeather();
    });

    if (elGeoBtn) {
      elGeoBtn.addEventListener("click", useMyLocation);
    }

    if (elAnimEnable && elAnimAmount) {
      elAnimEnable.addEventListener("change", () => {
        state.animEnable = elAnimEnable.checked;
        store.patch({ animEnable: state.animEnable });
        document.documentElement.style.setProperty(
          "--anim-amount",
          state.animEnable ? state.animAmount : 0
        );
        if (!state.animEnable) {
          document.documentElement.style.setProperty("--bg-angle", "160deg");
        }
      });

      elAnimAmount.addEventListener("input", () => {
        state.animAmount = parseFloat(elAnimAmount.value);
        if (state.animEnable) {
          document.documentElement.style.setProperty(
            "--anim-amount",
            state.animAmount
          );
        }
        store.patch({ animAmount: state.animAmount });
      });
    }

    if (elParallaxEnable && elParallaxAmount) {
      elParallaxEnable.addEventListener("change", () => {
        state.parallaxEnable = elParallaxEnable.checked;
        store.patch({ parallaxEnable: state.parallaxEnable });
        document.documentElement.style.setProperty(
          "--parallax-opacity",
          state.parallaxEnable ? state.parallaxAmount : 0
        );
      });

      elParallaxAmount.addEventListener("input", () => {
        state.parallaxAmount = parseFloat(elParallaxAmount.value);
        if (state.parallaxEnable) {
          document.documentElement.style.setProperty(
            "--parallax-opacity",
            state.parallaxAmount
          );
        }
        store.patch({ parallaxAmount: state.parallaxAmount });
      });
    }

    elWeatherDesatStrength.addEventListener("input", () => {
      state.weatherDesatStrength = parseFloat(elWeatherDesatStrength.value);
      const cf = state.lastCloudFrac || 0;
      state.weatherDesat = clamp(cf * state.weatherDesatStrength, 0, 1);
      store.patch({
        weatherDesatStrength: state.weatherDesatStrength,
        weatherDesat: state.weatherDesat,
      });
      const z = getZonedDate();
      const b = brightnessForTime(z.hours, z.minutes);
      applyPalette(state.monthIndex, b, z.seasonDate);
    });

    ["lat","lon"].forEach((id) => {
      $(id).addEventListener("change", () => {
        state.lat = elLat.value;
        state.lon = elLon.value;
        store.patch({ lat: state.lat, lon: state.lon });
        if (state.wxEnable) refreshWeather();
      });
    });

    if ("mediaSession" in navigator) {
      navigator.mediaSession.setActionHandler("play", () => {
        audio.play().catch(() => {});
      });
      navigator.mediaSession.setActionHandler("pause", () => {
        audio.pause();
      });
    }

    // Init
    setPlaylist(state.playlistName);
    const z0 = getZonedDate();
    const b0 = brightnessForTime(z0.hours, z0.minutes);
    applyPalette(state.monthIndex, b0, z0.seasonDate, state.weatherDesat);

    if (state.wxEnable) {
      refreshWeather();
    }

    if (location.hostname !== "localhost" && location.protocol !== "http:") {
      elHint.innerHTML +=
        " ‚Äî Tip: serve via <strong>http://localhost</strong> for smoother audio behavior.";
    }

    requestAnimationFrame(tick);
  </script>
</body>
</html>
